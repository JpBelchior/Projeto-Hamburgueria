generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────

enum Role {
  GERENTE
  ATENDENTE
}

enum Cargo {
  ATENDENTE
  COZINHEIRO
  CAIXA
}

enum CategoriaProduct {
  PRINCIPAL      
  ACOMPANHAMENTO 
  BEBIDA
  SOBREMESA
}

enum StatusPedido {
  ABERTO
  EM_PREPARO
  FINALIZADO
  CANCELADO
}

enum FormaPagamento {
  DINHEIRO
  CARTAO_CREDITO
  CARTAO_DEBITO
  PIX
}

enum UnidadeMedida {
  KG
  G
  LITRO
  ML
  UNIDADE
}

// ─────────────────────────────────────────
// USER — autenticação e acesso ao sistema
// ─────────────────────────────────────────

model User {
  id           Int          @id @default(autoincrement())
  name         String
  email        String       @unique
  password     String
  role         Role         @default(GERENTE)
  active       Boolean      @default(true)
  // Token de refresh — gerado no login, invalidado no logout
  refreshToken String?      @db.Text
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  funcionario Funcionario?

  @@map("users")
}

// ─────────────────────────────────────────
// FUNCIONÁRIO — dados profissionais
// ─────────────────────────────────────────

model Funcionario {
  id           Int       @id @default(autoincrement())
  userId       Int       @unique
  cargo        Cargo
  salario      Float
  dataAdmissao DateTime  @default(now())
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User      @relation(fields: [userId], references: [id])
  pedidos      Pedido[]

  @@map("funcionarios")
}

// ─────────────────────────────────────────
// INGREDIENTE — estoque
// ─────────────────────────────────────────

model Ingrediente {
  id              Int                  @id @default(autoincrement())
  nome            String               @unique
  quantidadeAtual Float
  unidade         UnidadeMedida
  custoPorUnidade Float
  essencial       Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  produtos        ProdutoIngrediente[]

  @@map("ingredientes")
}

// ─────────────────────────────────────────
// PRODUTO
// ─────────────────────────────────────────

model Produto {
  id                   Int                  @id @default(autoincrement())
  nome                 String
  descricao            String?              @db.Text
  categoria            CategoriaProduct
  precoVenda           Float
  tempoPreparoEstimado Int?
  ativo                Boolean              @default(true)
  imagem               String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  ingredientes         ProdutoIngrediente[]
  combos               ComboProduto[]
  pedidoItens          PedidoItem[]

  @@map("produtos")
}

// ─────────────────────────────────────────
// PRODUTO ↔ INGREDIENTE
// ─────────────────────────────────────────

model ProdutoIngrediente {
  produtoId       Int
  ingredienteId   Int
  quantidadeUsada Float

  produto         Produto     @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  ingrediente     Ingrediente @relation(fields: [ingredienteId], references: [id])

  @@id([produtoId, ingredienteId])
  @@map("produto_ingredientes")
}

// ─────────────────────────────────────────
// COMBO
// ─────────────────────────────────────────

model Combo {
  id          Int            @id @default(autoincrement())
  nome        String
  preco       Float
  ativo       Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  produtos    ComboProduto[]
  pedidoItens PedidoItem[]

  @@map("combos")
}

// ─────────────────────────────────────────
// COMBO ↔ PRODUTO
// ─────────────────────────────────────────

model ComboProduto {
  comboId    Int
  produtoId  Int
  quantidade Int     @default(1)

  combo      Combo   @relation(fields: [comboId], references: [id], onDelete: Cascade)
  produto    Produto @relation(fields: [produtoId], references: [id])

  @@id([comboId, produtoId])
  @@map("combo_produtos")
}

// ─────────────────────────────────────────
// PEDIDO
// ─────────────────────────────────────────

model Pedido {
  id                 Int             @id @default(autoincrement())
  numeroPedido       String          @unique
  nomeCliente        String?
  status             StatusPedido    @default(ABERTO)
  formaPagamento     FormaPagamento?
  valorTotal         Float           @default(0)
  funcionarioId      Int
  tempoInicioPreparo DateTime?
  tempoFimPreparo    DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  funcionario        Funcionario     @relation(fields: [funcionarioId], references: [id])
  itens              PedidoItem[]

  @@map("pedidos")
}

// ─────────────────────────────────────────
// PEDIDO ITEM — produto ou combo
// ─────────────────────────────────────────

model PedidoItem {
  id            Int     @id @default(autoincrement())
  pedidoId      Int
  produtoId     Int?
  comboId       Int?
  quantidade    Int
  precoUnitario Float
  observacao    String?

  pedido        Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  produto       Produto? @relation(fields: [produtoId], references: [id])
  combo         Combo?   @relation(fields: [comboId], references: [id])

  @@map("pedido_itens")
}
